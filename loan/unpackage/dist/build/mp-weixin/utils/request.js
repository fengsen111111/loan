"use strict";const e=require("../common/vendor.js"),t=require("./config.js");exports.request=function i(n,o={},a="POST"){let s=t.baseUrl+n;return new Promise((async(t,n)=>{let{file:r,fileType:d,params:l}=o;if("file"===d){let o=function(t,i){return e.crypto.enc.Base64.stringify(e.crypto.HmacSHA1(i,t))};const a=new Date;a.setHours(a.getHours()+1);const s={expiration:a.toISOString(),conditions:[["content-length-range",0,1073741824]]},d=await i("/factory_storage/File/refreshSTS"),c=e.gBase64.encode(JSON.stringify(s)),u=o(d.data.keySecret,c),g="user/"+l.fileName;e.index.getFileSystemManager(),l.fileSize;let f=await e.index.uploadFile({url:d.data.endpoint,filePath:r,name:"file",formData:{key:g,policy:c,OSSAccessKeyId:d.data.keyId,signature:u,"x-oss-security-token":d.data.token}});"uploadFile:ok"==f.errMsg?t(await i("/factory_storage/File/frontUpload",{url:d.data.endpoint+"/"+g,name:l.fileName,size:l.fileSize+"KB",upload_type:"oss",file_type:"image"})):(e.index.showToast({title:f.errMsg||"网络是否有点问题",duration:2e3,icon:"none"}),n())}else e.index.request({url:s,data:"{}"==JSON.stringify(o)?"":{post_params:o},method:a,header:{Authorization:e.index.getStorageSync("token")||""},timeout:6e3,success:i=>{let o=i.data;if(1==o.code)t(o);else{if(-1===o.code||-2===o.code){const t=e.index.getStorageSync("appType");e.index.clearStorageSync(),e.index.setStorageSync("appType",t),e.index.showToast({title:"登录验证失败，请重新登录",duration:2e3,icon:"none"}),setTimeout((()=>{e.index.reLaunch({url:"/pages/mine/index"})}),2200)}else e.index.showToast({title:o.message||"网络是否有点问题",duration:2e3,icon:"none"});n(o)}},fail:t=>{e.index.showToast({title:t.message||"网络是否有点问题",duration:2e3,icon:"none"}),n(t.errMsg)}})}))};
